function nmdrMenu(e){var n=nmdr.core.$(e,"nmdrMenu");if(null!=n)return n.imagePath="img/",n.menu=null,n.currentMenu=null,n.menus={},n.items={},n.init=function(e){e&&(this.imagePath=e+"/"),this.menu=this.prepareMenu();var n=this,t="#"+this.id+":hover {cursor:pointer;}.nmdrMenuTr {height:24px;}.nmdrMenuTr:hover {color:#fff;background:#33AAFF !important; cursor:pointer;}.nmdrMenuClose:hover {cursor:pointer;}hr.nmdrMenuHr {border:0px;height:1px;background-color:#B0C4DE;color:#B0C4DE}",i=document.createElement("style");i.type="text/css",i.styleSheet?i.styleSheet.cssText=t:i.appendChild(document.createTextNode(t)),document.head.appendChild(i);var o=function(e,t){var i=n.id+"_nmdrMenu_"+e.name,d=document.createElement("div");d.setAttribute("class","nmdrMenu"),d.setAttribute("id",i),d.style.cssText="position:absolute;top:-250;left:0;width:1px;height:1px;z-index:100;display:none;padding:3px;background-color:#fff;border:1px solid #bbb;font-family:arial,verdana,sans-serif;font-weight:normal;font-size:12px;box-shadow:5px 5px 5px #eee;",document.body.appendChild(d),e.id=i,e.dom=document.getElementById(i),e.parentMenu=t,e.opened=!1,null==e.width&&(e.width=150),null==e.showClose&&(e.showClose=!1),n.menus[i]=e;for(var s=0;s<e.items.length;s++){var r=e.items[s];r.menu&&o(r.menu,e)}};o(this.menu,null),this.onclick=function(e){n.openMenu(e,n.menu.id)}},n.makeMenu=function(e,n,t){if(t){n.dom.innerHTML="<div style='position:absolute; height:100%; width:100%; top:0px; left:0px; cursor:wait;background:#fff url("+this.imagePath+"loading.gif) no-repeat center center;opacity:0.75; z-index:101;'></div>";var i=e.target||e.srcElement,o=i.absPosition;return n.dom.style.position="absolute",n.dom.style.left=o.left+i.offsetWidth-20+"px",n.dom.style.top=o.top+4+"px",n.dom.style.width=n.width+"px",n.dom.style.height=20*n.items.length+"px",void(n.dom.style.display="block")}var d=[];d.push("<table cellpadding='0' cellspacing='0' border='0' width='100%' height='100%'>"),n.showClose&&(d.push("<tr style='height:20px'><td class='nmdrMenuClose' colspan='3' style='text-align:right;background:#eee;padding:2px 3px 0 0;'>"),d.push("<img class='nmdrMenuClose' src='"+this.imagePath+"dmclose.png' "),d.push("onclick=\"nmdr.core.$('"+this.id+"').closeMenu('"+n.id+"')\"></td></tr>"));for(var s=0,r=0,a=0;a<n.items.length;a++){var l=n.items[a];"#separator"==l.name?(d.push("<tr><td colspan='3'><hr class='nmdrMenuHr'></td></tr>"),s++):(l.id=n.id+"_tr"+a,d.push("<tr class='nmdrMenuTr' id='"+l.id+"' "),d.push((l.enabled?"onclick=\"nmdr.core.$('"+this.id+"').itemClick(event,'"+n.id+"',"+a+')"'+(l.menu?"":" onmouseover=\"nmdr.core.$('"+this.id+"').closeMenu('"+n.id+"', true)\""):"style='opacity:0.5;'")+">"),d.push("<td style='width:24px;padding:3px 0 0 5px;'><img src='"+this.imagePath+l.icon+"'></td>"),d.push("<td><span>"+l.name+"</span></td>"),d.push("<td style='width:10px;padding:0 0 0 0;'>"+(l.menu?"<img src='"+this.imagePath+"/submenu.gif'>":"")+"</td>"),d.push("</tr>"),r++)}d.push("</table>");var u=n.showClose?20:0;n.dom.style.width=n.width+"px",n.dom.style.height=24*r+14*s+u+"px",n.dom.innerHTML=d.join("")},n.canClose=function(e){if("nmdrMenuClose"==e.className)return!1;var n=function(t){for(var i=0;i<t.items.length;i++){var o=t.items[i];if(o.id==e.id)return o;for(var d=e.parentElement;null!=d;){if(d.id==o.id)return o;d=d.parentElement}if(o.menu)return n(o.menu)}return null},t=n(this.menu);return!t||!t.menu},n.openMenu=function(e,n){var t=this,i=this.menus[n];i.opened&&this.closeMenu(n,!0),t.makeMenu(e,i,!0),n==t.menu.id&&nmdr.core.popup.open(i.dom,t,null,function(e){t.closeMenu(t.menu.id,!1,e)},function(e,n){return t.canClose(n)}),nmdr.core.animate.fadeIn(null,i.dom,null,!0),window.setTimeout(function(){t.checkItems(i,function(){t.makeMenu(e,i,!1),i.opened=!0})},10)},n.closeMenu=function(e,n,t){var i=this,o=this.menus[e],d=function(o){for(var s=0;s<o.items.length;s++){var r=o.items[s];r.menu&&r.menu.opened&&(d(r.menu),document.getElementById(r.id).style.background="#ffffff")}n&&o.id==e||nmdr.core.animate.fadeOut(null,o.dom,null,!0,function(){if(o.dom.style.top="-250",o.dom.style.left="0",o.dom.style.display="none",o.opened=!1,o.id==i.menu.id)nmdr.core.popup.close(),t&&t();else if(o.parentMenu)for(var e=0;e<o.parentMenu.items.length;e++){var n=o.parentMenu.items[e];n.menu&&(document.getElementById(n.id).style.background="#ffffff")}})};d(o)},n.itemClick=function(e,n,t){var i=this.menus[n],o=i.items[t];if(o.menu)document.getElementById(o.id).style.background="#ABD6F5",this.openMenu(e,o.menu.id);else{var d=this;this.closeMenu(this.menu.id,!1,function(){d.execute(i.name,o.name)})}},n.checkItems=function(e,n){"M1"==e.name&&(e.items[2].enabled=!1),n()},n.execute=function(e,n){alert(e+"  "+n)},n.prepareMenu=function(){return{name:"M1",showClose:!1,width:200,items:[{name:"open item...",icon:"details.gif",enabled:!0,action:"view"},{name:"edit item...",icon:"editdetails.gif",enabled:!0,action:"edit"},{name:"delete item...",icon:"delete.gif",enabled:!0,action:"delete"},{name:"#separator"},{name:"show details...",icon:"new.gif",enabled:!0,action:"showdetails"},{name:"edit details...",icon:"edititem.gif",enabled:!0,action:"editdetails"},{name:"#separator"},{name:"refresh page...",icon:"menu/refpage.png",enabled:!0,action:"refresh",menu:{name:"SM1",showClose:!0,items:[{name:"show exchange..",icon:"menu/globalx.png",enabled:!0,action:"view"},{name:"edit item...",icon:"editdetails.gif",enabled:!0,action:"edit"},{name:"delete item...",icon:"uncheck.png",enabled:!0,action:"delete"},{name:"#separator"},{name:"user properties...",icon:"menu/users.png",enabled:!0,action:"refresh"}]}}]}},n}